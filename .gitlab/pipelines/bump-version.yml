bump version and tag:
  stage: bump
  needs: ["flake8 check", "black check", "isort check"]
  script:
    - !reference [.install_only_dev, script]
    - git config user.name "Philipp Oberdiek"
    - git config user.email "git@oberdiek.net"
    - echo "DATE=$(TZ=Etc/UTC date +'%Y-%m-%d')" >> variables.env
    - cz bump --yes
    - echo "VERSION=$(cz version --project)" >> variables.env
    - sed -E "/^## v$(cz version --project)/,/^## / ! d" CHANGELOG.md | head -n -2 | tail -n +3 > incremental-release.md
    - git push --follow-tags -o ci.skip "https://cicd-bump-token:$CICD_BUMP_TOKEN_VARIABLE@gitlab.com/wilfer9008/annotation-tool.git" HEAD:master
  artifacts:
    paths:
      - './incremental-release.md'
    reports:
      dotenv: variables.env
  rules:
    - if: '$BUMP_VERSION =~ /^./'

release new version:
  needs:
    - job: bump version and tag
      artifacts: true
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating a new release for v$VERSION"
  release:
    description: './incremental-release.md'
    tag_name: "v$VERSION"
  rules:
    - if: '$BUMP_VERSION =~ /^./'
